using System;
using System.Net;
using System.Net.Http;
using System.Threading.Tasks;
using System.Web;
using System.Web.Http;
using System.Web.Http.Description;
using System.Linq;
using System.Collections.Generic;
using System.Diagnostics;
using System.Text.RegularExpressions;
using Microsoft.Bot.Builder.Dialogs;
using Microsoft.Bot.Connector;
using SecCsChatBotDemo.DB;
using SecCsChatBotDemo.Models;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using System.Web.Script.Serialization;
using System.Linq.Expressions;
using System.Reflection;
using System.Threading;
using Microsoft.Bot.Builder.Luis;
using Microsoft.Bot.Builder.Luis.Models;
using Moq;


//KSO START
using System.Configuration;
using System.Web.Configuration;
//KSO END

namespace SecCsChatBotDemo
{
    [BotAuthentication]
    public class MessagesController : ApiController
    {

        public readonly string TEXTDLG = "2";
        public readonly string CARDDLG = "3";
        public readonly string MEDIADLG = "4";
        int userDataNum = 0;
        public TextDlgApiModel textJsonResult;
        public CarouselDlgApiModel carouselJsonResult;
        public MediaDlgApiModel mediaJsonResult;

        int sessionNo = 0;
        string[] strIntent = { };
        string[] strEntity = { };
        public static JObject Luis = new JObject();
		
		public static Configuration rootWebConfig = WebConfigurationManager.OpenWebConfiguration("/SecCsChatBotDemo");
        const string chatBotAppID = "appID";
        public static int appID = Convert.ToInt32(rootWebConfig.ConnectionStrings.ConnectionStrings[chatBotAppID].ToString());

        //public string Json = @"
        //        {
        //            ""conversationId"":""5412442"",
        //            ""dialogCount"":""2"",
        //            ""status"":""200"",
        //            ""dialogs"":
        //            [
        //                {
        //                    ""type"":""text"",
        //                    ""title"":""WELCOME"",
        //                    ""text"":""안녕하세요,S전자서비스센터챗봇앤이라고해요!""
        //                },
        //                {
        //                    ""type"":""text"",
        //                    ""text"":""고객님의세탁기모델명을입력해주세요.""
        //                }
        //            ]
        //        }";

        //public string Json = @"
        //        {
        //        ""conversationId"":""5412442"",
        //        ""dialogCount"":""2"",
        //        ""status"":""200"",
        //        ""dialogs"":
        //        [
	       //         {
		      //          ""type"":""carousel"",
		      //          ""herocards"":
		      //          [
			     //           {
				    //            ""type"":""herocard"",
				    //            ""title"":""가솔린모던2WD"",
				    //            ""subtitle"":"""",
				    //            ""text"":""가격:20,950,000원"",
				    //            ""media_url"":""https://test.img/test.jpg"",
        //                        ""card_division"":""img"",
        //                        ""card_value"":""1"",
				    //            ""buttons"":
				    //            [
					   //             {
						  //              ""type"":""imBack"",
						  //              ""title"":""트림자세히보기"",
						  //              ""values"":""가솔린모던2WD트림""
					   //             }
				    //            ]
			     //           },
			     //           {
				    //            ""type"":""herocard"",
				    //            ""title"":""가솔린모던ART2WD"",
				    //            ""subtitle"":"""",
				    //            ""text"":""가격:22,950,000원"",
				    //            ""media_url"":""https://test.img/test1.jpg"",
        //                        ""card_division"":""img"",
        //                        ""card_value"":""1"",
				    //            ""buttons"":
				    //            [
					   //             {
						  //              ""type"":""imBack"",
						  //              ""title"":""트림자세히보기"",
						  //              ""values"":""가솔린모던ART2WD트림""
					   //             }
				    //            ]
			     //           }
		      //          ]
	       //         }
        //        ]
        //        }";

        public string Json = @"
                {
	                ""conversationId"": ""5412442"",
	                ""dialogCount"": ""1"",
	                ""status"": ""200"",
	                ""dialogs"":
	                [
		                {
			                ""type"": ""media"",
			                ""title"": ""가솔린 모던 2WD"",
			                ""text"": ""가격: 20,950,000원"",
			                ""media_url"":""https://test.img/test.jpg"",
                            ""card_division"":""img"",
                            ""card_value"":""1"",
			                ""buttons"":
			                [
				                {
					                ""type"":""imBack"",
					                ""title"":""외장 색상"",
					                ""values"":""가솔린 모던 2WD 외장 색상""
				                },
				                {
					                ""type"":""imBack"",
					                ""title"":""내장 색상"",
					                ""values"":"" 가솔린 모던 2WD 내장 색상""
				                },
				                {
					                ""type"":""imBack"",
					                ""title"":""옵션 보기"",
					                ""values"":"" 가솔린 모던 2WD 옵션 보기""
				                }
			                ]
		                }
	                ]
                }";

        /// <summary>
        /// POST: api/Messages
        /// Receive a message from a user and reply to it
        /// </summary>
        public async Task<HttpResponseMessage> Post([FromBody]Activity activity)
        {
            //HttpResponseMessage response;
            
            

            var intentList = new List<string>();
            var entityList = new List<string>();

            if (activity.Type == ActivityTypes.ConversationUpdate && activity.MembersAdded.Any(m => m.Id == activity.Recipient.Id))
            {
                //await testFunc();
                //ParallelEncryt();

                //api json parsing

                if(JsonParsing(Json) == "text")
                {
                    textJsonResult = new TextDlgApiModel();
                    textJsonResult = TextJsonParsing(Json);
                }
                else if (JsonParsing(Json) == "carousel")
                {
                    carouselJsonResult = new CarouselDlgApiModel();
                    carouselJsonResult = CardJsonParsing(Json);
                }
                else if (JsonParsing(Json) == "media")
                {
                    mediaJsonResult = new MediaDlgApiModel();
                    mediaJsonResult = MediaJsonParsing(Json);
                }


                DateTime startTime = DateTime.Now;
                Debug.WriteLine("* DB conn : " + activity.Type);
                //Db
                DbConnect db = new DbConnect();
                List<DialogList> dlg = db.SelectInitDialog();
                

                ConnectorClient connector = new ConnectorClient(new Uri(activity.ServiceUrl));
                Debug.WriteLine("* dlg.Count : " + dlg.Count);
                for (int n = 0; n < dlg.Count; n++)
                {
                    Debug.WriteLine("* dlgId : " + n + "." + dlg[n].dlgId);
                    Activity reply2 = activity.CreateReply();
                    reply2.Recipient = activity.From;
                    reply2.Type = "message";
                    reply2.Attachments = new List<Attachment>();
                    reply2.AttachmentLayout = AttachmentLayoutTypes.Carousel;

                    List<CardList> card = db.SelectDialogCard(dlg[n].dlgId);
                    List<TextList> text = db.SelectDialogText(dlg[n].dlgId);
                    List<MediaList> media = db.SelectDialogMedia(dlg[n].dlgId);

                    for (int i = 0; i < text.Count; i++)
                    {
                        HeroCard plCard = new HeroCard()
                        {
                            Title = text[i].cardTitle,
                            Subtitle = text[i].cardText
                        };

                        Attachment plAttachment = plCard.ToAttachment();
                        reply2.Attachments.Add(plAttachment);
                    }

                    for (int i = 0; i < card.Count; i++)
                    {
                        List<CardImage> cardImages = new List<CardImage>();
                        List<CardAction> cardButtons = new List<CardAction>();

                        if (card[i].imgUrl != null)
                        {
                            cardImages.Add(new CardImage(url: card[i].imgUrl));
                        }

                        if (card[i].btn1Type != null)
                        {
                            CardAction plButton = new CardAction()
                            {
                                Value = card[i].btn1Context,
                                Type = card[i].btn1Type,
                                Title = card[i].btn1Title
                            };

                            cardButtons.Add(plButton);
                        }

                        if (card[i].btn2Type != null)
                        {
                            CardAction plButton = new CardAction()
                            {
                                Value = card[i].btn2Context,
                                Type = card[i].btn2Type,
                                Title = card[i].btn2Title
                            };

                            cardButtons.Add(plButton);
                        }

                        if (card[i].btn3Type != null)
                        {
                            CardAction plButton = new CardAction()
                            {
                                Value = card[i].btn3Context,
                                Type = card[i].btn3Type,
                                Title = card[i].btn3Title
                            };

                            cardButtons.Add(plButton);
                        }

                        HeroCard plCard = new HeroCard()
                        {
                            Title = card[i].cardTitle,
                            Subtitle = card[i].cardSubTitle,
                            Images = cardImages,
                            Buttons = cardButtons
                        };

                        Attachment plAttachment = plCard.ToAttachment();
                        reply2.Attachments.Add(plAttachment);
                    }

                    for (int i = 0; i < media.Count; i++)
                    {
                        List<MediaUrl> mediaURL = new List<MediaUrl>();
                        List<CardAction> cardButtons = new List<CardAction>();

                        if (media[i].mediaUrl != null)
                        {
                            mediaURL.Add(new MediaUrl(url: media[i].mediaUrl));
                        }

                        if (media[i].btn1Type != null)
                        {
                            CardAction plButton = new CardAction()
                            {
                                Value = media[i].btn1Context,
                                Type = media[i].btn1Type,
                                Title = media[i].btn1Title
                            };

                            cardButtons.Add(plButton);
                        }

                        if (media[i].btn2Type != null)
                        {
                            CardAction plButton = new CardAction()
                            {
                                Value = media[i].btn2Context,
                                Type = media[i].btn2Type,
                                Title = media[i].btn2Title
                            };

                            cardButtons.Add(plButton);
                        }

                        if (media[i].btn3Type != null)
                        {
                            CardAction plButton = new CardAction()
                            {
                                Value = media[i].btn3Context,
                                Type = media[i].btn3Type,
                                Title = media[i].btn3Title
                            };

                            cardButtons.Add(plButton);
                        }

                        VideoCard plCard = new VideoCard()
                        {
                            Title = media[i].cardTitle,
                            Text = media[i].cardText,
                            Media = mediaURL,
                            Buttons = cardButtons,
                            Autostart = false
                        };

                        Attachment plAttachment = plCard.ToAttachment();
                        reply2.Attachments.Add(plAttachment);
                    }

                    var reply1 = await connector.Conversations.SendToConversationAsync(reply2);
                }
                DateTime endTime = DateTime.Now;
                Debug.WriteLine("프로그램 수행시간 : {0}/ms", ((endTime - startTime).Milliseconds));
                Debug.WriteLine("* activity.Type : " + activity.Type);
                Debug.WriteLine("* activity.Recipient.Id : " + activity.Recipient.Id);
                Debug.WriteLine("* activity.ServiceUrl : " + activity.ServiceUrl);
                var welcome = "";
                var welcomeMsg = "";

            }
            else if (activity.Type == ActivityTypes.Message)
            {
                //await Conversation.SendAsync(activity, () => new Dialogs.RootDialog());
                Debug.WriteLine("* activity.Type == ActivityTypes.Message ");

                string orgMent = "";
                string orgENGMent_history = "";
                JObject Luis = new JObject();
                DbConnect db = new DbConnect();
                StateClient stateClient = activity.GetStateClient();
                BotData userData = await stateClient.BotState.GetUserDataAsync(activity.ChannelId, activity.From.Id);
                ConnectorClient connector = new ConnectorClient(new Uri(activity.ServiceUrl));
                
                orgMent = activity.Text;
                Debug.WriteLine("* orgMent : "+ orgMent);

                Luis = await GetIntentFromBotLUIS(orgMent);
                
                float luisScore = (float)Luis["intents"][0]["score"];
                int luisEntityCount = (int)Luis["entities"].Count();
                Debug.WriteLine("* Luis Entity Count : " + luisEntityCount);
                Debug.WriteLine("* Luis Intents Score : " + luisScore);

                //
 

                if (luisScore > 0 && luisEntityCount > 0)
                {
                    string intent = (string)Luis["intents"][0]["intent"];
                    string entity = (string)Luis["entities"][0]["entity"];
                    Debug.WriteLine("* 1.intent : " + intent + " || entity : "+ entity);
                    intent = intent.Replace("\"", "");
                    entity = entity.Replace("\"", "");
                    entity = entity.Replace(" ", "");
                    //Debug.WriteLine("* sessionNo : " + sessionNo ); 
                    //Debug.WriteLine("LUIS_INTENT : " + (string)(context.Session["LUIS_INTENT"]));
                    //Debug.WriteLine("LUIS_ENTITY : " + (string)(context.Session["LUIS_ENTITY"]));

                    //
                    sessionNo = sessionNo + 1;
 
                    //
                    intentList.Add(intent);
                    entityList.Add(entity);

                    // 
                    if (intent == "customerInfo")
                    {
                        var luisCustomerInfo = userData.GetProperty<string>("luisCustomerInfo");
                        if (entity == "김설현")
                        {
                            luisCustomerInfo = "";
                        }
                        //var luisCustomerInfo = userData.GetProperty<string>("luisCustomerInfo");
                        luisCustomerInfo = luisCustomerInfo + "\n" + orgMent;
                        userData.SetProperty<string>("luisCustomerInfo", luisCustomerInfo);
                        Debug.WriteLine("1-1.intent : customerInfo || input : " + orgMent + " || entity : " + entity + " || luisCustomerInfo : " + luisCustomerInfo);

                    }


                    //userData.SetProperty<List>(IList, intentList);
                    userData.SetProperty<string>("luisIntent", intent);
                    userData.SetProperty<string>("luisEntity", entity);

                    userData.SetProperty<string>(intent, orgENGMent_history);
                    Debug.WriteLine("* 2. orgENGMent_history : " + orgENGMent_history);
                    await stateClient.BotState.SetUserDataAsync(activity.ChannelId, activity.From.Id, userData);
                    Debug.WriteLine("* activity.ChannelId : " + activity.ChannelId + " || activity.From.Id : " + activity.From.Id);

                    List<LuisList> LuisDialogID = db.SelectLuis(intent, entity);

                    if (LuisDialogID.Count == 0)
                    {
                        Debug.WriteLine("* NO LuisDialogID");
                        Activity reply_err = activity.CreateReply();
                        reply_err.Recipient = activity.From;
                        reply_err.Type = "message";
                        reply_err.Text = "I'm sorry. I do not know what you mean.";
                        var reply1 = await connector.Conversations.SendToConversationAsync(reply_err);
                    }
                    else
                    {
                        Debug.WriteLine("* YES LuisDialogID || LuisDialogID.Count : " + LuisDialogID.Count);

                        for (int i = 0; i < LuisDialogID.Count; i++)
                        {
                            Activity reply2 = activity.CreateReply();
                            reply2.Recipient = activity.From;
                            reply2.Type = "message";
                            reply2.Attachments = new List<Attachment>();
                            reply2.AttachmentLayout = AttachmentLayoutTypes.Carousel;

                            int dlgID = LuisDialogID[i].dlgId;

                            

                            List<DialogList> dlg = db.SelectDialog(dlgID);

                            for (int n = 0; n < dlg.Count; n++)
                            {
                                string dlgType = dlg[n].dlgType;

                                if (dlgType == TEXTDLG)
                                {
                                    List<TextList> text = db.SelectDialogText(dlg[n].dlgId);

                                    for (int j = 0; j < text.Count; j++)
                                    {
                                        HeroCard plCard = new HeroCard()
                                        {
                                            Title = text[j].cardTitle,
                                            Subtitle = text[j].cardText
                                        };

                                        Attachment plAttachment = plCard.ToAttachment();
                                        reply2.Attachments.Add(plAttachment);
                                    }
                                }
                                else if (dlgType == CARDDLG)
                                {
                                    List<CardList> card = db.SelectDialogCard(dlg[n].dlgId);

                                    for (int j = 0; j < card.Count; j++)
                                    {
                                        List<CardImage> cardImages = new List<CardImage>();
                                        List<CardAction> cardButtons = new List<CardAction>();

                                        if (card[j].imgUrl != null)
                                        {
                                            cardImages.Add(new CardImage(url: card[j].imgUrl));
                                        }

                                        if (card[j].btn1Type != null)
                                        {
                                            CardAction plButton = new CardAction()
                                            {
                                                Value = card[j].btn1Context,
                                                Type = card[j].btn1Type,
                                                Title = card[j].btn1Title
                                            };

                                            cardButtons.Add(plButton);
                                        }

                                        if (card[j].btn2Type != null)
                                        {
                                            CardAction plButton = new CardAction()
                                            {
                                                Value = card[j].btn2Context,
                                                Type = card[j].btn2Type,
                                                Title = card[j].btn2Title
                                            };

                                            cardButtons.Add(plButton);
                                        }

                                        if (card[j].btn3Type != null)
                                        {
                                            CardAction plButton = new CardAction()
                                            {
                                                Value = card[j].btn3Context,
                                                Type = card[j].btn3Type,
                                                Title = card[j].btn3Title
                                            };

                                            cardButtons.Add(plButton);
                                        }

                                        var strCardSubTitle = card[j].cardSubTitle;
                                        if (card[j].dlgId == 2009)
                                        {
                                            //var customerInfo = userData.GetProperty<string>("luisCustomerInfo");
                                            strCardSubTitle = userData.GetProperty<string>("luisCustomerInfo");
                                        }
                                        
                                        HeroCard plCard = new HeroCard()
                                        {
                                            Title = card[j].cardTitle,
                                            //Subtitle = card[j].cardSubTitle,
                                            Subtitle = strCardSubTitle,
                                            Images = cardImages,
                                            Buttons = cardButtons
                                        };

                                        Attachment plAttachment = plCard.ToAttachment();
                                        reply2.Attachments.Add(plAttachment);
                                    }
                                }
                                else if (dlgType == MEDIADLG)
                                {
                                    List<MediaList> media = db.SelectDialogMedia(dlg[n].dlgId);

                                    for (int j = 0; j < media.Count; j++)
                                    {
                                        List<MediaUrl> mediaURL = new List<MediaUrl>();
                                        List<CardAction> cardButtons = new List<CardAction>();

                                        if (media[j].mediaUrl != null)
                                        {
                                            mediaURL.Add(new MediaUrl(url: media[j].mediaUrl));
                                        }

                                        if (media[j].btn1Type != null)
                                        {
                                            CardAction plButton = new CardAction()
                                            {
                                                Value = media[j].btn1Context,
                                                Type = media[j].btn1Type,
                                                Title = media[j].btn1Title
                                            };

                                            cardButtons.Add(plButton);
                                        }

                                        if (media[j].btn2Type != null)
                                        {
                                            CardAction plButton = new CardAction()
                                            {
                                                Value = media[j].btn2Context,
                                                Type = media[j].btn2Type,
                                                Title = media[j].btn2Title
                                            };

                                            cardButtons.Add(plButton);
                                        }

                                        if (media[j].btn3Type != null)
                                        {
                                            CardAction plButton = new CardAction()
                                            {
                                                Value = media[j].btn3Context,
                                                Type = media[j].btn3Type,
                                                Title = media[j].btn3Title
                                            };

                                            cardButtons.Add(plButton);
                                        }

                                        VideoCard plCard = new VideoCard()
                                        {
                                            Title = media[j].cardTitle,
                                            Text = media[j].cardText,
                                            Media = mediaURL,
                                            Buttons = cardButtons,
                                            Autostart = false
                                        };

                                        Attachment plAttachment = plCard.ToAttachment();
                                        reply2.Attachments.Add(plAttachment);
                                    }
                                }
                            }

                            var reply1 = await connector.Conversations.SendToConversationAsync(reply2);

                        }

                    }
                }
                else
                {
                    Debug.WriteLine("* NO Luis Score.. ");
                    Debug.WriteLine(userData.ToString());

                    //
                    var intentArray = intentList.ToArray();
 
                    foreach (string intent in intentList)
                    {
                        Debug.WriteLine("* intent[] :" + intent);
                        //System.Console.WriteLine(prime);
                    }
                    Debug.WriteLine("intentList" + intentList);
                    
                    Activity reply_err = activity.CreateReply();
 
                    //
                    var luisIntent = userData.GetProperty<string>("luisIntent");
                    var luisEntity = userData.GetProperty<string>("luisEntity");
                    Debug.WriteLine("** orgMent : " + orgMent + "| luisIntent : " + luisIntent + " | luisEntity : " + luisEntity);

                    List<LuisList> LuisDialogID = db.SelectLuisSecond(activity.Text, luisIntent, luisEntity);

                    if (LuisDialogID.Count == 0)
                    {
                        Debug.WriteLine("** NO LuisDialogID");
                        //Activity reply_err = activity.CreateReply();
                        reply_err.Recipient = activity.From;
                        reply_err.Type = "message";
                        reply_err.Text = "I'm sorry. I do not know what you mean.";
                        var reply1 = await connector.Conversations.SendToConversationAsync(reply_err);
                        
                    }
                    else
                    {
                        Debug.WriteLine("** SelectLuisSecond() YES | LuisDialogID | LuisDialogID.Count : " + LuisDialogID.Count);

                        for (int i = 0; i < LuisDialogID.Count; i++)
                        {
                            Activity reply2 = activity.CreateReply();
                            reply2.Recipient = activity.From;
                            reply2.Type = "message";
                            reply2.Attachments = new List<Attachment>();
                            reply2.AttachmentLayout = AttachmentLayoutTypes.Carousel;

                            int dlgID = LuisDialogID[i].dlgId;

                            string dlgIntent = LuisDialogID[i].dlgIntent;
                            string dlgEntities = LuisDialogID[i].dlgEntities;
                            
                            userData.SetProperty<string>("luisIntent", dlgIntent);
                            userData.SetProperty<string>("luisEntity", dlgEntities);
                            Debug.WriteLine("** userData.SetProperty > ("+ dlgID+") luisIntent: " + dlgIntent + "| luisEntity:" + dlgEntities);

                            await stateClient.BotState.SetUserDataAsync(activity.ChannelId, activity.From.Id, userData);

                            List <DialogList> dlg = db.SelectDialog(dlgID);

                            for (int n = 0; n < dlg.Count; n++)
                            {
                                string dlgType = dlg[n].dlgType;

                                if (dlgType == TEXTDLG)
                                {
                                    List<TextList> text = db.SelectDialogText(dlg[n].dlgId);

                                    for (int j = 0; j < text.Count; j++)
                                    {
                                        HeroCard plCard = new HeroCard()
                                        {
                                            Title = text[j].cardTitle,
                                            Subtitle = text[j].cardText
                                        };

                                        Attachment plAttachment = plCard.ToAttachment();
                                        reply2.Attachments.Add(plAttachment);
                                    }
                                }
                                else if (dlgType == CARDDLG)
                                {
                                    List<CardList> card = db.SelectDialogCard(dlg[n].dlgId);

                                    for (int j = 0; j < card.Count; j++)
                                    {
                                        List<CardImage> cardImages = new List<CardImage>();
                                        List<CardAction> cardButtons = new List<CardAction>();

                                        if (card[j].imgUrl != null)
                                        {
                                            cardImages.Add(new CardImage(url: card[j].imgUrl));
                                        }

                                        if (card[j].btn1Type != null)
                                        {
                                            CardAction plButton = new CardAction()
                                            {
                                                Value = card[j].btn1Context,
                                                Type = card[j].btn1Type,
                                                Title = card[j].btn1Title
                                            };

                                            cardButtons.Add(plButton);
                                        }

                                        if (card[j].btn2Type != null)
                                        {
                                            CardAction plButton = new CardAction()
                                            {
                                                Value = card[j].btn2Context,
                                                Type = card[j].btn2Type,
                                                Title = card[j].btn2Title
                                            };

                                            cardButtons.Add(plButton);
                                        }

                                        if (card[j].btn3Type != null)
                                        {
                                            CardAction plButton = new CardAction()
                                            {
                                                Value = card[j].btn3Context,
                                                Type = card[j].btn3Type,
                                                Title = card[j].btn3Title
                                            };

                                            cardButtons.Add(plButton);
                                        }

                                        HeroCard plCard = new HeroCard()
                                        {
                                            Title = card[j].cardTitle,
                                            Subtitle = card[j].cardSubTitle,
                                            Images = cardImages,
                                            Buttons = cardButtons
                                        };

                                        Attachment plAttachment = plCard.ToAttachment();
                                        reply2.Attachments.Add(plAttachment);
                                    }
                                }
                                else if (dlgType == MEDIADLG)
                                {
                                    List<MediaList> media = db.SelectDialogMedia(dlg[n].dlgId);

                                    for (int j = 0; j < media.Count; j++)
                                    {
                                        List<MediaUrl> mediaURL = new List<MediaUrl>();
                                        List<CardAction> cardButtons = new List<CardAction>();

                                        if (media[j].mediaUrl != null)
                                        {
                                            mediaURL.Add(new MediaUrl(url: media[j].mediaUrl));
                                        }

                                        if (media[j].btn1Type != null)
                                        {
                                            CardAction plButton = new CardAction()
                                            {
                                                Value = media[j].btn1Context,
                                                Type = media[j].btn1Type,
                                                Title = media[j].btn1Title
                                            };

                                            cardButtons.Add(plButton);
                                        }

                                        if (media[j].btn2Type != null)
                                        {
                                            CardAction plButton = new CardAction()
                                            {
                                                Value = media[j].btn2Context,
                                                Type = media[j].btn2Type,
                                                Title = media[j].btn2Title
                                            };

                                            cardButtons.Add(plButton);
                                        }

                                        if (media[j].btn3Type != null)
                                        {
                                            CardAction plButton = new CardAction()
                                            {
                                                Value = media[j].btn3Context,
                                                Type = media[j].btn3Type,
                                                Title = media[j].btn3Title
                                            };

                                            cardButtons.Add(plButton);
                                        }

                                        VideoCard plCard = new VideoCard()
                                        {
                                            Title = media[j].cardTitle,
                                            Text = media[j].cardText,
                                            Media = mediaURL,
                                            Buttons = cardButtons,
                                            Autostart = false
                                        };

                                        Attachment plAttachment = plCard.ToAttachment();
                                        reply2.Attachments.Add(plAttachment);
                                    }
                                }
                            }

                            var reply1 = await connector.Conversations.SendToConversationAsync(reply2);
                            
                        }


                    }
                }
            }
            else
            {
                HandleSystemMessage(activity);
            }
            var response = Request.CreateResponse(HttpStatusCode.OK);
            return response;
        }

        private Activity HandleSystemMessage(Activity message)
        {
            if (message.Type == ActivityTypes.DeleteUserData)
            {
                // Implement user deletion here
                // If we handle user deletion, return a real message
            }
            else if (message.Type == ActivityTypes.ConversationUpdate)
            {
                // Handle conversation state changes, like members being added and removed
                // Use Activity.MembersAdded and Activity.MembersRemoved and Activity.Action for info
                // Not available in all channels
            }
            else if (message.Type == ActivityTypes.ContactRelationUpdate)
            {
                // Handle add/remove from contact lists
                // Activity.From + Activity.Action represent what happened
            }
            else if (message.Type == ActivityTypes.Typing)
            {
                // Handle knowing tha the user is typing
            }
            else if (message.Type == ActivityTypes.Ping)
            {
            }

            return null;
        }

        private static async Task<JObject> GetIntentFromBotLUIS(string Query)
        {
            Query = Uri.EscapeDataString(Query);
            JObject jsonObj = new JObject();
            string[] RequestURI = new string[1];
            //RequestURI[0] = "https://westus.api.cognitive.microsoft.com/luis/v2.0/apps/ac08a04f-3a5a-4bae-9eaa-47fe069d01b5?subscription-key=7489b95cf3fb4797939ea70ce94a4b11" + "&timezoneOffset=0&verbose=true&q=" + Query;
            //RequestURI[1] = "https://westus.api.cognitive.microsoft.com/luis/v2.0/apps/b1437ec6-3301-4c24-8bcb-1af58ee2c47c?subscription-key=7efb093087dd48918b903885b944740c" + "&timezoneOffset=0&verbose=true&q=" + Query;
            //RequestURI[0] = "https://westus.api.cognitive.microsoft.com/luis/v2.0/apps/83f7cb60-6027-4fbb-b3da-d6d4d4b5a40f?subscription-key=03067a6e4dca40ee9766a8fa9da6d864" + "&timezoneOffset=0&verbose=true&q=" + Query;
            RequestURI[0] = "https://westus.api.cognitive.microsoft.com/luis/v2.0/apps/5ba3e658-7b1a-45bc-92a8-faa29f553f2a?subscription-key=03067a6e4dca40ee9766a8fa9da6d864" + "&timezoneOffset=0&verbose=true&q=" + Query;
            using (HttpClient client = new HttpClient())
            {
                for (int i = 0; i < RequestURI.Length; i++)
                {
                    HttpResponseMessage msg = await client.GetAsync(RequestURI[i]);

                    if (msg.IsSuccessStatusCode)
                    {
                        var JsonDataResponse = await msg.Content.ReadAsStringAsync();
                        jsonObj = JObject.Parse(JsonDataResponse);
                    }
                    msg.Dispose();

                    if (jsonObj["entities"].Count() != 0 && (float)jsonObj["intents"][0]["score"] > 0.3)
                    {
                        break;
                    }
                }
            }
            return jsonObj;
        }

        Func<Task> testFunc = async () =>
        {
            Debug.WriteLine("In");
            Luis = await GetIntentFromBotLUIS("출장서비스예약");
            await Task.Delay(100);
            Luis = await GetIntentFromBotLUIS("세 탁 기 작 동 시 소 음 이 심 하 게 납 니 다 .");
            //await Task.Delay(100);
            //Luis = await GetIntentFromBotLUIS("출장서비스예약");
        };



        const int MAX = 3;
        const int SHIFT = 3;


        static void ParallelEncryt()
        {
            //string text = "출장서비스예약";
            List<string> textList = new List<string>(MAX);
            //for (int i = 0; i < MAX; i++)
            //{
            //    textList.Add(text);
            //}
            textList.Add("출장서비스예약");
            textList.Add("네 요 청 합 니 다");
            textList.Add("우 리 집 세 탁 기 가 고 장 난 것 같 아 요");

            
            System.Diagnostics.Stopwatch watch = new System.Diagnostics.Stopwatch();
            watch.Start();
            Parallel.For(0, MAX, async async =>
            {
                string chArr = textList[async].ToString();

                Luis = await GetIntentFromBotLUIS(chArr);

                Debug.WriteLine("["+async + "] top scoring : " + Luis["intents"][0]["intent"]);

            });
            watch.Stop();

            Debug.WriteLine(watch.Elapsed.ToString());
        }

        
        private static string JsonParsing(string a)
        {
            Dictionary<string, JsonParseModel> jsonType = new Dictionary<string, JsonParseModel>();
            string result = "";
            var JSONObj = new JavaScriptSerializer().Deserialize<JsonParseModel>(a);
            if (JSONObj.status == 200)
            {

                result = JSONObj.dialogs[0].type;

                return result;
            }


            return null;
        }

        //Dictionary<string,int> _DicSample;
        private static TextDlgApiModel TextJsonParsing(string a)
        {
            Dictionary<string, TextDlgApiModel> textValues = new Dictionary<string, TextDlgApiModel>();

            var textJSONObj = new JavaScriptSerializer().Deserialize<TextDlgApiModel>(a);
            if (textJSONObj.status == 200)
            {
                Debug.WriteLine(textJSONObj.conversationId);
                Debug.WriteLine(textJSONObj.status);
                Debug.WriteLine(textJSONObj.dialogCount);
                Debug.WriteLine(textJSONObj.dialogs.Count);

                for (int i = 0; i < textJSONObj.dialogs.Count; i++)
                {
                    Debug.WriteLine(textJSONObj.dialogs[i].type);
                    Debug.WriteLine(textJSONObj.dialogs[i].title);
                    Debug.WriteLine(textJSONObj.dialogs[i].text);

                    //textValues.Add


                }
                return textJSONObj;
            }


            return null;
        }

        private static CarouselDlgApiModel CardJsonParsing(string a)
        {
            Dictionary<string, CarouselDlgApiModel> cardValues = new Dictionary<string, CarouselDlgApiModel>();

            var carouselJSONObj = new JavaScriptSerializer().Deserialize<CarouselDlgApiModel>(a);
            if (carouselJSONObj.status == 200)
            {
                Debug.WriteLine(carouselJSONObj.conversationId);
                Debug.WriteLine(carouselJSONObj.status);
                Debug.WriteLine(carouselJSONObj.dialogCount);
                Debug.WriteLine(carouselJSONObj.dialogs.Count);

                for (int i = 0; i < carouselJSONObj.dialogs.Count; i++)
                {
                    Debug.WriteLine(carouselJSONObj.dialogs[i].type);
                    Debug.WriteLine(carouselJSONObj.dialogs[i].herocards.Count);


                    for (int n = 0; n < carouselJSONObj.dialogs[i].herocards.Count; n++)
                    {
                        Debug.WriteLine(carouselJSONObj.dialogs[i].herocards[n].type);
                        Debug.WriteLine(carouselJSONObj.dialogs[i].herocards[n].title);
                        Debug.WriteLine(carouselJSONObj.dialogs[i].herocards[n].subtitle);
                        Debug.WriteLine(carouselJSONObj.dialogs[i].herocards[n].text);
                        Debug.WriteLine(carouselJSONObj.dialogs[i].herocards[n].media_url);
                        Debug.WriteLine(carouselJSONObj.dialogs[i].herocards[n].card_division);
                        Debug.WriteLine(carouselJSONObj.dialogs[i].herocards[n].card_value);
                        Debug.WriteLine(carouselJSONObj.dialogs[i].herocards[n].buttons.Count);

                        for (int m = 0; m < carouselJSONObj.dialogs[i].herocards[n].buttons.Count; m++)
                        {
                            Debug.WriteLine(carouselJSONObj.dialogs[i].herocards[n].buttons[m].type);
                            Debug.WriteLine(carouselJSONObj.dialogs[i].herocards[n].buttons[m].title);
                            Debug.WriteLine(carouselJSONObj.dialogs[i].herocards[n].buttons[m].values);
                        }

                    }

                }
                return carouselJSONObj;
            }


            return null;
        }

        private static MediaDlgApiModel MediaJsonParsing(string a)
        {
            Dictionary<string, MediaDlgApiModel> MediaValues = new Dictionary<string, MediaDlgApiModel>();

            var mediaJSONObj = new JavaScriptSerializer().Deserialize<MediaDlgApiModel>(a);
            if (mediaJSONObj.status == 200)
            {
                Debug.WriteLine(mediaJSONObj.conversationId);
                Debug.WriteLine(mediaJSONObj.status);
                Debug.WriteLine(mediaJSONObj.dialogCount);
                Debug.WriteLine(mediaJSONObj.dialogs.Count);

                for (int i = 0; i < mediaJSONObj.dialogs.Count; i++)
                {
                    Debug.WriteLine(mediaJSONObj.dialogs[i].type);
                    Debug.WriteLine(mediaJSONObj.dialogs[i].title);
                    Debug.WriteLine(mediaJSONObj.dialogs[i].text);
                    Debug.WriteLine(mediaJSONObj.dialogs[i].media_url);
                    Debug.WriteLine(mediaJSONObj.dialogs[i].card_division);
                    Debug.WriteLine(mediaJSONObj.dialogs[i].card_value);
                    Debug.WriteLine(mediaJSONObj.dialogs[i].buttons.Count);

                    for (int n = 0; n < mediaJSONObj.dialogs[i].buttons.Count; n++)
                    {
                        Debug.WriteLine(mediaJSONObj.dialogs[i].buttons[n].type);
                        Debug.WriteLine(mediaJSONObj.dialogs[i].buttons[n].title);
                        Debug.WriteLine(mediaJSONObj.dialogs[i].buttons[n].values);
                    }

                }
                return mediaJSONObj;
            }


            return null;
        }

 //       public static void SetupLuis<D>(
 //           Mock<ILuisService> luis,
 //           Expression<Func<D, Task>> expression,
 //           double? score,
 //           params EntityRecommendation[] entities
 //           )
 //       {
 //           luis
 //               .Setup(l => l.QueryAsync(It.IsAny<Uri>(), It.IsAny<CancellationToken>()))
 //               .ReturnsAsync(new LuisResult()
 //               {
 //                   Intents = IntentsFor(expression, score),
 //                   Entities = entities
 //               });
 //       }

 //       public static IntentRecommendation[] IntentsFor<D>(Expression<Func<D, Task>> expression, double? score)
 //       {
 //           var body = (MethodCallExpression)expression.Body;
 //           var attributes = body.Method.GetCustomAttributes<LuisIntentAttribute>();
 //           var intents = attributes
 //               .Select(attribute => new IntentRecommendation(attribute.IntentName, score))
 //               .ToArray();
 //           return intents;
 //       }

 //       public void Uri_Building()
 //       {
 //           const string Model = "model";
 //           const string Subscription = "subscription";
 //           const string Domain = "domain";
 //           const string Text = "text";


 //           // TODO: xunit theory 
 //           var tests = new[]
 //           { 
 //#pragma warning disable CS0612 
 //                new { m = new LuisModelAttribute(Model, Subscription, LuisApiVersion.V1, null) { }, u = new Uri("https://api.projectoxford.ai/luis/v1/application?subscription-key=subscription&q=text&id=model&log=True") },
 //                new { m = new LuisModelAttribute(Model, Subscription, LuisApiVersion.V1, null) { Log = false, SpellCheck = false, Staging = false, TimezoneOffset = 1, Verbose = false }, u = new Uri("https://api.projectoxford.ai/luis/v1/application?subscription-key=subscription&q=text&id=model&log=False&spellCheck=False&staging=False&timezoneOffset=1&verbose=False") },
 //                new { m = new LuisModelAttribute(Model, Subscription, LuisApiVersion.V1, Domain) { Log = true, SpellCheck = true, Staging = true, TimezoneOffset = 2, Verbose = true }, u = new Uri("https://api.projectoxford.ai/luis/v1/application?subscription-key=subscription&q=text&id=model&log=True&spellCheck=True&staging=True&timezoneOffset=2&verbose=True") }, 
 //#pragma warning restore CS0612 
 //                new { m = new LuisModelAttribute(Model, Subscription, LuisApiVersion.V2, null) { }, u = new Uri("https://westus.api.cognitive.microsoft.com/luis/v2.0/apps/model?subscription-key=subscription&q=text&log=True") },
 //                new { m = new LuisModelAttribute(Model, Subscription, LuisApiVersion.V2, null) { Log = false, SpellCheck = false, Staging = false, TimezoneOffset = 1, Verbose = false }, u = new Uri("https://westus.api.cognitive.microsoft.com/luis/v2.0/apps/model?subscription-key=subscription&q=text&log=False&spellCheck=False&staging=False&timezoneOffset=1&verbose=False") },
 //                new { m = new LuisModelAttribute(Model, Subscription, LuisApiVersion.V2, Domain) { Log = true, SpellCheck = true, Staging = true, TimezoneOffset = 2, Verbose = true }, u = new Uri("https://domain/luis/v2.0/apps/model?subscription-key=subscription&q=text&log=True&spellCheck=True&staging=True&timezoneOffset=2&verbose=True") },
 //            };


 //           foreach (var test in tests)
 //           {
 //               ILuisService service = new LuisService(test.m);
 //               var actual = service.BuildUri(Text);
 //               Assert.AreEqual(test.u, actual);
 //           }
 //       }


    }
}